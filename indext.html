<!DOCTYPE html>
<html lang="it">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>A Tutto Reality: La Sfida Online</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
Â  Â  Â  Â  Â  Â  background-color: #f0e6d2;
Â  Â  Â  Â  }
Â  Â  Â  Â  .font-bangers { font-family: 'Bangers', cursive; }
Â  Â  Â  Â  .btn {
Â  Â  Â  Â  Â  Â  @apply font-bangers text-2xl text-white bg-green-600 border-4 border-black rounded-full px-8 py-3 shadow-[8px_8px_0px_rgba(0,0,0,1)] transition-all duration-200;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn:hover {
Â  Â  Â  Â  Â  Â  @apply bg-green-700 shadow-[6px_6px_0px_rgba(0,0,0,1)] translate-x-[2px] translate-y-[2px];
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn:active {
Â  Â  Â  Â  Â  Â  @apply bg-green-800 shadow-[2px_2px_0px_rgba(0,0,0,1)] translate-x-[6px] translate-y-[6px];
Â  Â  Â  Â  }
Â  Â  Â  Â  .panel {
Â  Â  Â  Â  Â  Â  @apply bg-amber-100 border-4 border-black rounded-2xl p-6 shadow-[10px_10px_0px_rgba(0,0,0,0.8)];
Â  Â  Â  Â  }
Â  Â  Â  Â  .character-card {
Â  Â  Â  Â  Â  Â  @apply border-4 border-black rounded-lg p-2 text-center transition-transform duration-200 cursor-pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .character-card.selected-by-me { @apply bg-blue-400 border-blue-600; }
Â  Â  Â  Â  .character-card.selected-by-other { @apply bg-gray-400 border-gray-600 cursor-not-allowed opacity-60; }
Â  Â  Â  Â  .character-card:not(.selected-by-other):hover { @apply transform scale-105; }
Â  Â  Â  Â  .team-color-1 { background-color: #ef4444; } /* red-500 */
Â  Â  Â  Â  .team-color-2 { background-color: #22c55e; } /* green-500 */
Â  Â  Â  Â  .team-color-3 { background-color: #3b82f6; } /* blue-500 */
Â  Â  Â  Â  .team-color-4 { background-color: #f97316; } /* orange-500 */

Â  Â  Â  Â  /* Stili Chat */
Â  Â  Â  Â  .chat-container { @apply flex flex-col h-full bg-amber-200 border-4 border-black rounded-xl; }
Â  Â  Â  Â  .chat-messages { @apply flex-grow p-4 overflow-y-auto; }
Â  Â  Â  Â  .chat-message { @apply mb-2; }
Â  Â  Â  Â  .chat-message .sender { @apply font-bold; }
Â  Â  Â  Â  .chat-input-form { @apply flex p-2 border-t-4 border-black; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Indicatore personaggio */
Â  Â  Â  Â  .my-character-indicator img {
Â  Â  Â  Â  Â  Â  @apply ring-4 ring-yellow-400 ring-offset-2 ring-offset-amber-100;
Â  Â  Â  Â  }
Â  Â  Â  Â  .safe-player-indicator img {
Â  Â  Â  Â  Â  Â  @apply ring-4 ring-green-500 ring-offset-2 ring-offset-amber-100;
Â  Â  Â  Â  }
Â  Â  Â  Â  .immune-player-indicator img {
Â  Â  Â  Â  Â  Â  @apply ring-4 ring-purple-500 ring-offset-2 ring-offset-amber-100;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Animazioni */
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
Â  Â  Â  Â  .fade-in { animation: fadeIn 0.5s ease-in-out; }
Â  Â  </style>
</head>
<body class="bg-amber-50 text-gray-800">

Â  Â  <div id="app" class="container mx-auto p-4 min-h-screen flex flex-col items-center justify-center">
Â  Â  Â  Â  <!-- L'applicazione verrÃ  renderizzata qui -->
Â  Â  </div>

Â  Â  <!-- Modale per messaggi -->
Â  Â  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
Â  Â  Â  Â  <div class="panel max-w-md w-full text-center">
Â  Â  Â  Â  Â  Â  <h3 id="modal-title" class="font-bangers text-4xl text-red-600 mb-4">Attenzione!</h3>
Â  Â  Â  Â  Â  Â  <p id="modal-message" class="text-lg mb-6"></p>
Â  Â  Â  Â  Â  Â  <button id="modal-close" class="btn bg-red-500 hover:bg-red-600">Chiudi</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  // Importa le funzioni necessarie da Firebase
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, query, where, updateDoc, writeBatch, addDoc, serverTimestamp, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â  Â  Â  Â  // --- CONFIGURAZIONE FIREBASE ---
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyBRdVmq9sIUJsLubKPTVUV0a1AIVpndhcA",
Â  Â  Â  Â  Â  Â  authDomain: "total-drama-la-sfida.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "total-drama-la-sfida",
Â  Â  Â  Â  Â  Â  storageBucket: "total-drama-la-sfida.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "668431070513",
Â  Â  Â  Â  Â  Â  appId: "1:668431070513:web:bd2a955d6ebfdc810d6c10",
Â  Â  Â  Â  Â  Â  measurementId: "G-QE0Z4XWTBG"
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Questo ID identifica l'applicazione nel database. Puoi lasciarlo cosÃ¬.
Â  Â  Â  Â  const appId = 'a-tutto-reality-online';

Â  Â  Â  Â  // Inizializza Firebase
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const db = getFirestore(app);


Â  Â  Â  Â  // --- DATI PREDEFINITI ---
Â  Â  Â  Â  const FULL_CHARACTER_POOL = [
Â  Â  Â  Â  Â  Â  { name: "Candace", img: "https://i.pinimg.com/originals/1c/99/dc/1c99dc178ad0635627477c24254be37e.gif" },
Â  Â  Â  Â  Â  Â  { name: "Shinobu", img: "https://i.pinimg.com/originals/85/79/8e/85798e1981256fb35437bc755263c199.gif" },
Â  Â  Â  Â  Â  Â  { name: "Stellarubia", img: "https://i.pinimg.com/originals/04/ca/52/04ca5288d93bfe2bd47fbfe61c3ab6bd.gif" },
Â  Â  Â  Â  Â  Â  { name: "Lisa", img: "https://i.pinimg.com/originals/bb/1e/a0/bb1ea08a3f394a583e49466a27269702.gif" },
Â  Â  Â  Â  Â  Â  { name: "Nicole", img: "https://media1.tenor.com/m/hoZOijyaXTMAAAAC/the-amazing-world-of-gumball-nicole-watterson.gif" },
Â  Â  Â  Â  Â  Â  { name: "Garnet", img: "https://i.pinimg.com/originals/15/c5/92/15c592711b85314cecc49f4d5cb840e6.gif" },
Â  Â  Â  Â  Â  Â  { name: "Wanda", img: "https://media.tenor.com/8GITD5dPhl4AAAAM/wanda-clucking.gif" },
Â  Â  Â  Â  Â  Â  { name: "Fiona", img: "https://i.pinimg.com/originals/76/79/0b/76790bf7d2ca51ac60cb2fb22d45d0de.gif" },
Â  Â  Â  Â  Â  Â  { name: "Lapis", img: "https://i.pinimg.com/originals/8c/89/b1/8c89b1c86c32046422fdf07cb3f84921.gif" },
Â  Â  Â  Â  Â  Â  { name: "Gwen", img: "https://media.tenor.com/83wH-eEZQA4AAAAM/gwen-total-drama.gif" },
Â  Â  Â  Â  Â  Â  { name: "Velma", img: "https://i.pinimg.com/originals/d6/88/2c/d6882cd3f134979be924254b186cb01b.gif" },
Â  Â  Â  Â  Â  Â  { name: "Gommarosa", img: "https://i.pinimg.com/originals/f0/a2/63/f0a263c8848f14ba56651023d1afff91.gif" },
Â  Â  Â  Â  Â  Â  { name: "Gumball", img: "https://i.pinimg.com/originals/2a/51/64/2a5164c11b0468154dbcef44858e0769.gif" },
Â  Â  Â  Â  Â  Â  { name: "Stewie", img: "https://i.pinimg.com/originals/71/96/0f/71960fbdf396f732051c2e88a6c39443.gif" },
Â  Â  Â  Â  Â  Â  { name: "Patrick", img: "https://i.pinimg.com/originals/f9/e7/a0/f9e7a02065d880479c13d61b5d60f4f2.gif" },
Â  Â  Â  Â  Â  Â  { name: "Superboy", img: "https://i.pinimg.com/originals/94/a7/a7/94a7a7c2ee640fd4bdb9e623138c0467.gif" },
Â  Â  Â  Â  Â  Â  { name: "Gatto con gli stivali", img: "https://i.pinimg.com/originals/20/a7/20/20a7208d655c6d8f882fb4dfbacbc9fe.gif" },
Â  Â  Â  Â  Â  Â  { name: "Riolu", img: "https://i.pinimg.com/originals/e6/02/5d/e6025d56bfd79ae41e35f042148b57fb.gif" },
Â  Â  Â  Â  Â  Â  { name: "Johnny Bravo", img: "https://i.pinimg.com/originals/42/ef/0e/42ef0e9d902e54195316e9e6b5c48384.gif" },
Â  Â  Â  Â  Â  Â  { name: "Leone", img: "https://i.pinimg.com/originals/e1/d4/c7/e1d4c7ddfa20bbfdd77b564e548a4c3c.gif" },
Â  Â  Â  Â  Â  Â  { name: "Daffy", img: "https://i.pinimg.com/originals/0e/44/5f/0e445f6ddf7edc630ca49d844f58d34d.gif" },
Â  Â  Â  Â  Â  Â  { name: "Finn", img: "https://i.pinimg.com/originals/b2/51/17/b25117aace36f09451366283fc495008.gif" },
Â  Â  Â  Â  Â  Â  { name: "Robin", img: "https://i.pinimg.com/originals/49/42/73/4942739889be29a32da4a801e2fb4b9b.gif" },
Â  Â  Â  Â  Â  Â  { name: "Tenebra", img: "https://i.pinimg.com/originals/41/86/d5/4186d52093b622a9e0d596670cd65a0c.gif" },
Â  Â  Â  Â  Â  Â  { name: "Corvina", img: "https://media.tenor.com/ISJbIzN97cgAAAAM/raven-teen-titans.gif" },
Â  Â  Â  Â  Â  Â  { name: "Rose Quartz", img: "https://i.pinimg.com/originals/8b/27/33/8b2733b306c721fa069775d0829ca17e.gif" },
Â  Â  Â  Â  Â  Â  { name: "Orso Bianco", img: "https://i.pinimg.com/originals/43/a3/7f/43a37f37dee174a7548bbb42e25fdcf4.gif" },
Â  Â  Â  Â  Â  Â  { name: "Carlos", img: "https://i.pinimg.com/originals/32/0d/d1/320dd13031f1aba8a2d3d9b9837174f4.gif" },
Â  Â  Â  Â  Â  Â  { name: "Leon", img: "https://i.pinimg.com/originals/ad/58/df/ad58dfbdc13b5ed3ac50f7f5cd8984fb.gif" },
Â  Â  Â  Â  Â  Â  { name: "Robot Boy", img: "https://i.pinimg.com/originals/79/a0/4e/79a04e45499fdeba56c62a0465101e58.gif" },
Â  Â  Â  Â  Â  Â  { name: "Spongebob", img: "https://i.pinimg.com/originals/4c/74/21/4c742132b3f7018e49ae1901a2ab3e68.gif" },
Â  Â  Â  Â  Â  Â  { name: "Rosalinda", img: "https://i.pinimg.com/originals/37/6b/2c/376b2cfa68dcb3b52e4e309d5a29ad49.gif" },
Â  Â  Â  Â  Â  Â  { name: "Bloom", img: "https://i.pinimg.com/originals/2a/32/55/2a325525e2f610702d3ca4458be37a51.gif" },
Â  Â  Â  Â  Â  Â  { name: "Ponygon", img: "https://i.pinimg.com/originals/d3/70/64/d37064767df0ef73ec0602aa7b858967.gif" },
Â  Â  Â  Â  Â  Â  { name: "Francine", img: "https://i.pinimg.com/originals/fd/22/19/fd2219f7edf041a1982a234cb1fbbe00.gif" },
Â  Â  Â  Â  Â  Â  { name: "Roger", img: "https://i.pinimg.com/originals/f7/46/d9/f746d9350dbc2bf82e10b4596d192db0.gif" },
Â  Â  Â  Â  Â  Â  { name: "Ben 10", img: "https://i.pinimg.com/originals/7e/ea/10/7eea10f977a11a928eb203fe887e4522.gif" },
Â  Â  Â  Â  Â  Â  { name: "Androide 18", img: "https://i.pinimg.com/originals/65/74/e1/6574e1409f35f8ec1e626c1f69b04858.gif" },
Â  Â  Â  Â  Â  Â  { name: "Timmy", img: "https://i.pinimg.com/originals/5e/d9/33/5ed933a2f1b50617533feea46bbfc3d0.gif" },
Â  Â  Â  Â  Â  Â  { name: "Clarence", img: "https://i.pinimg.com/originals/7a/dd/7b/7add7b7b3d85d034780220623f08aba2.gif" },
Â  Â  Â  Â  Â  Â  { name: "Mordecai", img: "https://i.pinimg.com/originals/f4/ed/a8/f4eda82fa731f8b677cecedbcd1d358b.gif" },
Â  Â  Â  Â  Â  Â  { name: "Ellis", img: "https://i.pinimg.com/originals/3b/10/2c/3b102c22d54b391bfb50b1bbf75d3c43.gif" },
Â  Â  Â  Â  Â  Â  { name: "Daphne", img: "https://i.pinimg.com/originals/f1/cd/c8/f1cdc823a641797c38d3a26f6f9e4914.gif" },
Â  Â  Â  Â  Â  Â  { name: "Tecna", img: "https://i.pinimg.com/originals/43/44/da/4344da043aec0946577af8dba8bee564.gif" },
Â  Â  Â  Â  Â  Â  { name: "Zatch Bell", img: "https://i.pinimg.com/originals/c4/c7/63/c4c76304a85365557533f04bc2e07d21.gif" },
Â  Â  Â  Â  Â  Â  { name: "Shizuka", img: "https://i.pinimg.com/originals/68/8b/f3/688bf3cd0803d0ba7b3c7b1f8c0f8cf0.gif" },
Â  Â  Â  Â  Â  Â  { name: "Perry", img: "https://i.pinimg.com/originals/56/27/82/562782974be6adfdd03b37aa807dd2c1.gif" },
Â  Â  Â  Â  Â  Â  { name: "Mabel", img: "https://i.pinimg.com/originals/16/c6/f4/16c6f49f87040238b1ee63152f65eb6d.gif" },
Â  Â  Â  Â  Â  Â  { name: "Heather", img: "https://media.tenor.com/IwBy4Qxyus4AAAAM/heather-heathertotaldrama.gif" },
Â  Â  Â  Â  Â  Â  { name: "Danny Phantom", img: "https://i.pinimg.com/originals/22/99/8e/22998efdb246a5c9c79c1173684981f8.gif" }
Â  Â  Â  Â  ];

Â  Â  Â  Â  // --- STATO GLOBALE DELL'APPLICAZIONE ---
Â  Â  Â  Â  let globalState = {
Â  Â  Â  Â  Â  Â  currentUser: null,
Â  Â  Â  Â  Â  Â  currentScreen: 'loading',
Â  Â  Â  Â  Â  Â  nickname: '',
Â  Â  Â  Â  Â  Â  gameId: null,
Â  Â  Â  Â  Â  Â  gameData: null,
Â  Â  Â  Â  Â  Â  chatMessages: [],
Â  Â  Â  Â  Â  Â  unsubscribeGame: null,
Â  Â  Â  Â  Â  Â  unsubscribeChat: null,
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- ELEMENTI DOM ---
Â  Â  Â  Â  const appContainer = document.getElementById('app');
Â  Â  Â  Â  const modal = document.getElementById('modal');
Â  Â  Â  Â  const modalTitle = document.getElementById('modal-title');
Â  Â  Â  Â  const modalMessage = document.getElementById('modal-message');
Â  Â  Â  Â  const modalClose = document.getElementById('modal-close');

Â  Â  Â  Â  // --- FUNZIONI DI UTILITÃ€ ---
Â  Â  Â  Â  const showModal = (message, title = "Attenzione!") => {
Â  Â  Â  Â  Â  Â  modalTitle.textContent = title;
Â  Â  Â  Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  Â  Â  Â  modal.classList.remove('hidden');
Â  Â  Â  Â  };
Â  Â  Â  Â  modalClose.addEventListener('click', () => modal.classList.add('hidden'));

Â  Â  Â  Â  const generateId = (length = 5) => {
Â  Â  Â  Â  Â  Â  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ123456789';
Â  Â  Â  Â  Â  Â  let result = '';
Â  Â  Â  Â  Â  Â  for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
Â  Â  Â  Â  Â  Â  return result;
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FUNZIONI DI RENDERIZZAZIONE ---
Â  Â  Â  Â  const render = () => {
Â  Â  Â  Â  Â  Â  const screenContainer = document.getElementById('screen-container');
Â  Â  Â  Â  Â  Â  if (!screenContainer) appContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  switch (globalState.currentScreen) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'loading': renderLoading(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'mainMenu': renderMainMenu(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'createGame': renderCreateGame(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'joinGame': renderJoinGame(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'findGame': renderFindGame(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'lobby': renderLobby(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'characterSelection': renderCharacterSelection(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'game': renderGame(); break;
Â  Â  Â  Â  Â  Â  Â  Â  default: renderMainMenu();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderWithSidePanels = (screenHtml) => {
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 h-[85vh]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="screen-container" class="lg:col-span-2 h-full overflow-y-auto p-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${screenHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="h-full flex flex-col gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${renderPlayerInfoPanel()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow min-h-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${renderChat()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderPlayerInfoPanel = () => {
Â  Â  Â  Â  Â  Â  if (!globalState.gameData) return '';

Â  Â  Â  Â  Â  Â  const myPlayer = globalState.gameData.players.find(p => p.uid === globalState.currentUser.uid);
Â  Â  Â  Â  Â  Â  if (!myPlayer || myPlayer.characterIndex === null) return '';

Â  Â  Â  Â  Â  Â  const character = globalState.gameData.settings.characters[myPlayer.characterIndex];
Â  Â  Â  Â  Â  Â  const statusText = myPlayer.status === 'eliminated' ? 'Eliminato' : 'In Gara';
Â  Â  Â  Â  Â  Â  const statusColor = myPlayer.status === 'eliminated' ? 'text-red-600' : 'text-green-600';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel p-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-2xl text-center mb-2">Il Tuo Personaggio</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${character.img || 'https://placehold.co/80x80/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/333?text=Error';" class="w-20 h-20 object-cover rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-xl">${character.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold ${statusColor}">${statusText}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderChat = () => {
Â  Â  Â  Â  Â  Â  const messagesHtml = globalState.chatMessages.map(msg => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-message">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="sender" style="color: ${msg.senderColor || '#333'}">${msg.senderName}:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${msg.text}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-3xl text-center p-2 bg-amber-300 border-b-4 border-black">Chat</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="chat-messages" class="chat-messages">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${messagesHtml || '<p class="text-gray-500">Nessun messaggio ancora...</p>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="chat-form" class="chat-input-form">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="chat-input" class="w-full p-2 border-2 border-black rounded-l-lg" placeholder="Scrivi un messaggio...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn text-xl py-1 px-4 rounded-l-none">Invia</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const updateChatView = () => {
Â  Â  Â  Â  Â  Â  const chatMessagesContainer = document.getElementById('chat-messages');
Â  Â  Â  Â  Â  Â  if (chatMessagesContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  const messagesHtml = globalState.chatMessages.map(msg => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-message">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="sender" style="color: ${msg.senderColor || '#333'}">${msg.senderName}:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${msg.text}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â  Â  Â  chatMessagesContainer.innerHTML = messagesHtml || '<p class="text-gray-500">Nessun messaggio ancora...</p>';
Â  Â  Â  Â  Â  Â  Â  Â  chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderLoading = () => { appContainer.innerHTML = `<h1 class="font-bangers text-6xl text-center">Caricamento...</h1>`; };

Â  Â  Â  Â  const renderMainMenu = () => {
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center w-full max-w-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="font-bangers text-8xl text-yellow-400" style="text-shadow: 4px 4px 0 #000, -4px -4px 0 #000, 4px -4px 0 #000, -4px 4px 0 #000, 4px 0 0 #000, -4px 0 0 #000, 0 4px 0 #000, 0 -4px 0 #000;">A Tutto Reality</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-6xl text-white mb-8" style="text-shadow: 3px 3px 0 #000;">La Sfida Online</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="nickname-input" class="block font-bold mb-2 text-xl">Inserisci il tuo Nickname:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="text" id="nickname-input" class="w-full p-3 text-center text-xl font-bold border-4 border-black rounded" maxlength="15" value="${globalState.nickname}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="goToCreateGame" class="btn">Crea Partita</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="goToJoinGame" class="btn">Unisciti con Codice</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="goToFindGame" class="btn">Cerca Stanza Disponibile</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderCreateGame = () => {
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel w-full max-w-4xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-4xl text-center mb-6">Crea la tua Partita</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="create-game-form" class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block font-bold mb-2">Numero Giocatori (12-30):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="player-count" value="24" min="12" max="30" class="w-full p-2 border-2 border-black rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block font-bold mb-2">Numero Team (2-4):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="team-count" value="2" min="2" max="4" class="w-full p-2 border-2 border-black rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="team-configs" class="space-y-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block font-bold mb-2">Episodio del Merge:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="merge-episode" value="7" min="2" class="w-full p-2 border-2 border-black rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block font-bold mb-2">Ritorni in gara (0, 1, o 2):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="return-count" value="1" min="0" max="2" class="w-full p-2 border-2 border-black rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="return-episodes" class="space-y-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr class="border-black my-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-3xl">Personaggi Personalizzati</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="characters-list" class="space-y-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-action="addCharacter" class="btn bg-blue-500 hover:bg-blue-600 text-xl py-2">Aggiungi Personaggio</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr class="border-black my-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn">Crea e Vai alla Lobby</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-action="goToMainMenu" class="btn bg-gray-500 hover:bg-gray-600 mt-4">Indietro</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  updateTeamConfigs();
Â  Â  Â  Â  Â  Â  updateReturnEpisodes();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const shuffledPool = [...FULL_CHARACTER_POOL].sort(() => 0.5 - Math.random());
Â  Â  Â  Â  Â  Â  const playerCountInput = document.getElementById('player-count');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const populateCharacters = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const list = document.getElementById('characters-list');
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  const count = parseInt(playerCountInput.value);
Â  Â  Â  Â  Â  Â  Â  Â  for(let i = 0; i < count; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addCharacterRow(i, shuffledPool);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  populateCharacters();
Â  Â  Â  Â  Â  Â  playerCountInput.addEventListener('change', populateCharacters);

Â  Â  Â  Â  Â  Â  document.getElementById('team-count').addEventListener('change', updateTeamConfigs);
Â  Â  Â  Â  Â  Â  document.getElementById('return-count').addEventListener('change', updateReturnEpisodes);
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderJoinGame = () => {
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel max-w-md w-full text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-4xl mb-6">Unisciti con Codice</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="join-game-form">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="game-code" placeholder="INSERISCI CODICE" class="w-full p-3 text-center text-2xl font-bold uppercase border-4 border-black rounded mb-4" maxlength="5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn">Unisciti</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="button" data-action="goToMainMenu" class="btn bg-gray-500 hover:bg-gray-600 mt-4">Indietro</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderFindGame = async () => {
Â  Â  Â  Â  Â  Â  Â appContainer.innerHTML = `<div class="panel w-full max-w-lg"><h2 class="font-bangers text-4xl text-center mb-4">Stanze Disponibili</h2><div id="game-list-container">Caricamento...</div><button type="button" data-action="goToMainMenu" class="btn bg-gray-500 hover:bg-gray-600 mt-6">Indietro</button></div>`;
Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  const gamesRef = collection(db, `artifacts/${appId}/public/data/games`);
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(gamesRef, where("status", "==", "waiting"));
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â  const gameListContainer = document.getElementById('game-list-container');
Â  Â  Â  Â  Â  Â  Â  Â  if (querySnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameListContainer.innerHTML = '<p class="text-center">Nessuna stanza disponibile al momento. Creane una!</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  let listHtml = '<ul class="space-y-3">';
Â  Â  Â  Â  Â  Â  Â  Â  querySnapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const game = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="flex justify-between items-center bg-amber-200 p-3 rounded border-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold">Stanza ${doc.id} (${game.players.length}/${game.settings.playerCount})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="joinWithId" data-id="${doc.id}" class="btn bg-blue-500 hover:bg-blue-600 text-xl py-1 px-4">Entra</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  listHtml += '</ul>';
Â  Â  Â  Â  Â  Â  Â  Â  gameListContainer.innerHTML = listHtml;
Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Errore nel cercare le partite:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('game-list-container').innerHTML = '<p class="text-center text-red-600">Errore nel caricamento.</p>';
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderLobby = () => {
Â  Â  Â  Â  Â  Â  if (!globalState.gameData) { renderLoading(); return; }
Â  Â  Â  Â  Â  Â  const { settings, players, hostId, id } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const isHost = globalState.currentUser.uid === hostId;
Â  Â  Â  Â  Â  Â  let playersHtml = players.map(p => `<li class="bg-amber-200 p-2 rounded border-2 border-black">${p.name} ${p.uid === hostId ? 'ðŸ‘‘' : ''}</li>`).join('');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const screenHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-4xl text-center mb-2">Lobby</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center font-bold text-2xl mb-4">Codice Stanza: <span class="text-red-600 bg-white px-2 rounded border-2 border-black">${id}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center mb-4">In attesa di altri giocatori... (${players.length}/${settings.playerCount})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="space-y-2 mb-6 h-64 overflow-y-auto p-2 bg-white border-2 border-black rounded">${playersHtml}</ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isHost ? `<button data-action="startGame" class="btn">Avvia Partita</button>` : '<p class="font-bold">Solo l\'host puÃ² avviare la partita.</p>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="leaveGame" class="btn bg-red-500 hover:bg-red-600 mt-4">Esci</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isHost ? `<button data-action="testFinale" class="btn bg-yellow-500 hover:bg-yellow-600 mt-4">Test Finale</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = renderWithSidePanels(screenHtml);
Â  Â  Â  Â  Â  Â  updateChatView();
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderCharacterSelection = () => {
Â  Â  Â  Â  Â  Â  const { settings, players } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const myUid = globalState.currentUser.uid;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const charactersHtml = settings.characters.map((char, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const playerWhoSelected = players.find(p => p.characterIndex === index);
Â  Â  Â  Â  Â  Â  Â  Â  let cardClass = 'bg-amber-200';
Â  Â  Â  Â  Â  Â  Â  Â  let selectedText = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (playerWhoSelected) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (playerWhoSelected.uid === myUid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardClass = 'selected-by-me';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedText = '<p class="font-bold text-white text-sm mt-1">SELEZIONATO DA TE</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardClass = 'selected-by-other';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedText = '<p class="font-bold text-white text-sm mt-1">GIÃ€ PRESO</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div data-action="selectCharacter" data-index="${index}" class="character-card ${cardClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${char.img || 'https://placehold.co/100x100/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/333?text=Error';" class="w-24 h-24 object-cover mx-auto rounded-md border-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold mt-2 truncate">${char.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${selectedText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  const screenHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-4xl text-center mb-4">Scegli il tuo Personaggio</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center mb-6">Scegli segretamente il personaggio che vuoi interpretare. La tua scelta non sarÃ  visibile agli altri.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${charactersHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center mt-6 font-bold">In attesa che tutti i giocatori scelgano...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = renderWithSidePanels(screenHtml);
Â  Â  Â  Â  Â  Â  updateChatView();
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderGame = () => {
Â  Â  Â  Â  Â  Â  const myPlayer = globalState.gameData.players.find(p => p.uid === globalState.currentUser.uid);
Â  Â  Â  Â  Â  Â  const isEliminated = myPlayer.status === 'eliminated';
Â  Â  Â  Â  Â  Â  const { status } = globalState.gameData;

Â  Â  Â  Â  Â  Â  // Handle final stages first, as spectators should see them too.
Â  Â  Â  Â  Â  Â  if (status === 'game_over') {
Â  Â  Â  Â  Â  Â  Â  Â  renderGameOver();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (status === 'finale') {
Â  Â  Â  Â  Â  Â  Â  Â  renderFinale();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // If an eliminated player is viewing before the finale, show the spectator view.
Â  Â  Â  Â  Â  Â  if (isEliminated) {
Â  Â  Â  Â  Â  Â  Â  Â  renderSpectatorView();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // From here on, only active players will execute this code.
Â  Â  Â  Â  Â  Â  if (status === 'tiebreaker') {
Â  Â  Â  Â  Â  Â  Â  Â  renderTiebreaker();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const { settings, players, teams, episode, challengeResult, votes, elimination, isMerged, immunePlayerUid } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const getCharacter = (player) => settings.characters[player.characterIndex];

Â  Â  Â  Â  Â  Â  let mainContentHtml = '';
Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  const allPlayersHtml = players.filter(p => p.status === 'active').map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isMyCharacter = myPlayer && p.characterIndex === myPlayer.characterIndex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isImmune = p.uid === immunePlayerUid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let indicatorClass = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMyCharacter) indicatorClass = 'my-character-indicator';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isImmune) indicatorClass = 'immune-player-indicator';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative flex flex-col items-center text-center ${indicatorClass}" title="${getCharacter(p).name}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${getCharacter(p).img || 'https://placehold.co/80x80/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/333?text=Error';" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-sm mt-1 truncate max-w-[80px]">${getCharacter(p).name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isImmune ? `<p class="absolute -bottom-4 font-bangers text-xl text-purple-600" style="text-shadow: 1px 1px 0 #fff;">IMMUNE</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  Â  mainContentHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel bg-gray-700 text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-4xl text-center mb-4" style="text-shadow: 2px 2px 0 #000;">MERGE!</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-4 sm:grid-cols-6 gap-4">${allPlayersHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mainContentHtml = teams.map(team => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const membersHtml = players
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(p => p.teamId === team.id && p.status === 'active')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isMyCharacter = myPlayer && p.characterIndex === myPlayer.characterIndex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isSafe = elimination && elimination.safePlayers && elimination.safePlayers.includes(p.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let indicatorClass = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMyCharacter) indicatorClass = 'my-character-indicator';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isSafe) indicatorClass = 'safe-player-indicator';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative flex flex-col items-center text-center ${indicatorClass}" title="${getCharacter(p).name}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${getCharacter(p).img || 'https://placehold.co/80x80/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/333?text=Error';" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-sm mt-1 truncate max-w-[80px]">${getCharacter(p).name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isSafe ? `<p class="absolute -bottom-4 font-bangers text-xl text-green-600" style="text-shadow: 1px 1px 0 #fff;">SALVO</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}).join('');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel team-color-${team.id} text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-3xl text-center mb-4" style="text-shadow: 2px 2px 0 #000;">Team ${team.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">${membersHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const isHost = globalState.currentUser.uid === globalState.gameData.hostId;
Â  Â  Â  Â  Â  Â  let gameControls = '';
Â  Â  Â  Â  Â  Â  let statusMessage = '';

Â  Â  Â  Â  Â  Â  if (status === 'challenge') {
Â  Â  Â  Â  Â  Â  Â  Â  statusMessage = `<h2 class="font-bangers text-5xl text-center my-4">Episodio ${episode}: Pronti per la sfida!</h2>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(isHost) gameControls = `<button data-action="runChallenge" class="btn mt-6">Avvia Sfida</button>`;
Â  Â  Â  Â  Â  Â  } else if (status === 'challenge_result') {
Â  Â  Â  Â  Â  Â  Â  Â  const winningTeams = teams.filter(t => challengeResult.winningTeamIds.includes(t.id));
Â  Â  Â  Â  Â  Â  Â  Â  const losingTeam = teams.find(t => t.id === challengeResult.losingTeamId);
Â  Â  Â  Â  Â  Â  Â  Â  statusMessage = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-5xl text-center my-4">Risultato Sfida!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-2xl font-bold text-green-600">Team Vincenti: ${winningTeams.map(t=>t.name).join(', ')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-xl font-bold text-red-600 mt-2">Team Perdente: ${losingTeam.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  if(isHost) gameControls = `<button data-action="goToElimination" class="btn mt-6">Vai alla Cerimonia</button>`;
Â  Â  Â  Â  Â  Â  } else if (status === 'elimination') {
Â  Â  Â  Â  Â  Â  Â  Â  statusMessage = `<h2 class="font-bangers text-5xl text-center my-4 text-red-600">Cerimonia di Eliminazione!</h2>`;
Â  Â  Â  Â  Â  Â  Â  Â  const alreadyVoted = votes && votes[myPlayer.uid];
Â  Â  Â  Â  Â  Â  Â  Â  if(alreadyVoted) statusMessage += `<p class="text-center font-bold">Hai votato. In attesa degli altri...</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  else statusMessage += renderVoteScreen();
Â  Â  Â  Â  Â  Â  } else if (status === 'reveal') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMessage = `<h2 class="font-bangers text-5xl text-center my-4">Il Momento della VeritÃ ...</h2><p class="text-center">L'host sta per rivelare i voti...</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isHost) gameControls = `<button data-action="startVoteReveal" class="btn mt-6">Inizia a Rivelare i Voti</button>`;
Â  Â  Â  Â  Â  Â  } else if (status === 'reveal_in_progress') {
Â  Â  Â  Â  Â  Â  Â  Â  const lastSafePlayerUid = elimination.safePlayers[elimination.safePlayers.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  const lastSafePlayer = players.find(p => p.uid === lastSafePlayerUid);
Â  Â  Â  Â  Â  Â  Â  Â  const lastSafeCharacter = getCharacter(lastSafePlayer);
Â  Â  Â  Â  Â  Â  Â  Â  const votesForSafe = elimination.voteCounts[lastSafePlayerUid] || 0;
Â  Â  Â  Â  Â  Â  Â  Â  statusMessage = `<h2 class="font-bangers text-4xl text-center my-4">${lastSafeCharacter.name} Ã¨ salvo con ${votesForSafe} voti!</h2>`;

Â  Â  Â  Â  Â  Â  Â  Â  if(elimination.atRisk.length - elimination.safePlayers.length === 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMessage += `<p class="font-bangers text-3xl text-center text-red-600 my-4">Siamo arrivati agli ultimi due...</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if(isHost) gameControls = `<button data-action="revealNextSafe" class="btn mt-6">Rivela Prossimo Salvo</button>`;

Â  Â  Â  Â  Â  Â  } else if (status === 'revealed') {
Â  Â  Â  Â  Â  Â  Â  Â  const eliminatedPlayer = players.find(p => p.uid === elimination.eliminatedUid);
Â  Â  Â  Â  Â  Â  Â  Â  const eliminatedChar = getCharacter(eliminatedPlayer);
Â  Â  Â  Â  Â  Â  Â  Â  const votesForEliminated = elimination.voteCounts[elimination.eliminatedUid] === 'Spareggio' ? 'allo spareggio' : `con ${elimination.voteCounts[elimination.eliminatedUid]} voti`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusMessage = `<h2 class="font-bangers text-5xl text-center my-4 text-red-700">${eliminatedChar.name} Ã¨ stato eliminato ${votesForEliminated}!</h2>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isHost) gameControls = `<button data-action="nextEpisode" class="btn mt-6">Prossimo Episodio</button>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const screenHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusMessage}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 ${isMerged ? '' : 'md:grid-cols-2'} gap-6 mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${mainContentHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${gameControls}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${renderEliminationRanking()}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = renderWithSidePanels(screenHtml);
Â  Â  Â  Â  Â  Â  updateChatView();
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderSpectatorView = () => {
Â  Â  Â  Â  Â  Â  const screenHtml = renderGameHtmlForSpectator();
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = renderWithSidePanels(screenHtml);
Â  Â  Â  Â  Â  Â  updateChatView();
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderGameHtmlForSpectator = () => {
Â  Â  Â  Â  Â  Â  const { settings, players, status, hostId, teams, isMerged, immunePlayerUid, elimination } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const isHost = globalState.currentUser.uid === hostId;
Â  Â  Â  Â  Â  Â  const getCharacter = (player) => settings.characters[player.characterIndex];
Â  Â  Â  Â  Â  Â  let hostControls = '';

Â  Â  Â  Â  Â  Â  if (isHost) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (status === 'challenge') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â hostControls = `<button data-action="runChallenge" class="btn mt-6">Avvia Sfida</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (status === 'challenge_result') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â hostControls = `<button data-action="goToElimination" class="btn mt-6">Vai alla Cerimonia</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (status === 'reveal') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hostControls = `<button data-action="startVoteReveal" class="btn mt-6">Inizia a Rivelare i Voti</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (status === 'reveal_in_progress') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hostControls = `<button data-action="revealNextSafe" class="btn mt-6">Rivela Prossimo Salvo</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (status === 'revealed') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hostControls = `<button data-action="nextEpisode" class="btn mt-6">Prossimo Episodio</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let mainContentHtml = '';
Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  const allPlayersHtml = players.filter(p => p.status === 'active').map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isImmune = p.uid === immunePlayerUid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative flex flex-col items-center text-center ${isImmune ? 'immune-player-indicator' : ''}" title="${getCharacter(p).name}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${getCharacter(p).img || 'https://placehold.co/80x80/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/333?text=Error';" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-sm mt-1 truncate max-w-[80px]">${getCharacter(p).name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isImmune ? '<p class="absolute -bottom-4 font-bangers text-xl text-purple-600" style="text-shadow: 1px 1px 0 #fff;">IMMUNE</p>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  Â  mainContentHtml = `<div class="panel bg-gray-700 text-white"><h3 class="font-bangers text-4xl text-center mb-4" style="text-shadow: 2px 2px 0 #000;">MERGE!</h3><div class="grid grid-cols-4 sm:grid-cols-6 gap-4">${allPlayersHtml}</div></div>`;
Â  Â  Â  Â  Â  Â  } else if (teams) {
Â  Â  Â  Â  Â  Â  Â  Â  Â mainContentHtml = teams.map(team => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const membersHtml = players.filter(p => p.teamId === team.id && p.status === 'active').map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isSafe = elimination && elimination.safePlayers && elimination.safePlayers.includes(p.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative flex flex-col items-center text-center ${isSafe ? 'safe-player-indicator' : ''}" title="${getCharacter(p).name}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${getCharacter(p).img || 'https://placehold.co/80x80/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/333?text=Error';" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-sm mt-1 truncate max-w-[80px]">${getCharacter(p).name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isSafe ? '<p class="absolute -bottom-4 font-bangers text-xl text-green-600" style="text-shadow: 1px 1px 0 #fff;">SALVO</p>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}).join('');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="panel team-color-${team.id} text-white"><h3 class="font-bangers text-3xl text-center mb-4" style="text-shadow: 2px 2px 0 #000;">Team ${team.name}</h3><div class="grid grid-cols-3 sm:grid-cols-4 gap-4">${membersHtml}</div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-5xl text-red-600">SEI STATO ELIMINATO!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl mt-4">Stai assistendo alla partita come spettatore.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 ${isMerged ? '' : 'md:grid-cols-2'} gap-6 mt-6">${mainContentHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mt-6">${hostControls}</div>
Â  Â  Â  Â  Â  Â  Â  Â  ${renderEliminationRanking()}
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderVoteScreen = () => {
Â  Â  Â  Â  Â  Â  const { players, settings, isMerged, immunePlayerUid } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const myPlayer = players.find(p => p.uid === globalState.currentUser.uid);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let voteOptions;
Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  voteOptions = players.filter(p => p.status === 'active' && p.uid !== myPlayer.uid && p.uid !== immunePlayerUid);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  voteOptions = players.filter(p => p.teamId === myPlayer.teamId && p.status === 'active' && p.uid !== myPlayer.uid);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const voteOptionsHtml = voteOptions.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const character = settings.characters[p.characterIndex];
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div data-action="votePlayer" data-uid="${p.uid}" class="character-card bg-amber-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${character.img || 'https://placehold.co/100x100/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/333?text=Error';" class="w-24 h-24 object-cover mx-auto rounded-md border-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold mt-2">${character.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel mt-6 max-w-3xl mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-3xl text-center mb-4">Vota chi eliminare!</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${voteOptionsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderEliminationRanking = () => {
Â  Â  Â  Â  Â  Â  const { eliminationOrder, players, settings } = globalState.gameData;
Â  Â  Â  Â  Â  Â  if (!eliminationOrder || eliminationOrder.length === 0) return '';

Â  Â  Â  Â  Â  Â  const rankingHtml = eliminationOrder.map((uid, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const player = players.find(p => p.uid === uid);
Â  Â  Â  Â  Â  Â  Â  Â  if (!player) return '';
Â  Â  Â  Â  Â  Â  Â  Â  const character = settings.characters[player.characterIndex];
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-3 bg-amber-200 p-2 rounded border-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bangers text-2xl">${settings.playerCount - index}Â°</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${character.img || 'https://placehold.co/40x40/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/e2e8f0/333?text=Error';" class="w-10 h-10 object-cover rounded-full border-2 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold">${character.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-3xl text-center mb-4">Classifica di Eliminazione</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${rankingHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderTiebreaker = () => {
Â  Â  Â  Â  Â  Â  Â const { settings, players, tiebreaker } = globalState.gameData;
Â  Â  Â  Â  Â  Â  Â const myPlayer = players.find(p => p.uid === globalState.currentUser.uid);
Â  Â  Â  Â  Â  Â  Â const iAmInTiebreaker = tiebreaker.players.some(p => p.uid === myPlayer.uid);
Â  Â  Â  Â  Â  Â  Â const myRollInfo = iAmInTiebreaker ? tiebreaker.players.find(p => p.uid === myPlayer.uid) : null;
Â  Â  Â  Â  Â  Â  Â const isHost = globalState.currentUser.uid === globalState.gameData.hostId;

Â  Â  Â  Â  Â  Â  Â const getCharacter = (player) => settings.characters[player.characterIndex];

Â  Â  Â  Â  Â  Â  Â const playersInTiebreakerHtml = tiebreaker.players.map(pInfo => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const player = players.find(p => p.uid === pInfo.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <img src="${getCharacter(player).img || 'https://placehold.co/80x80/e2e8f0/333?text=?'}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/333?text=Error';" class="w-24 h-24 object-cover mx-auto rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="font-bold text-xl mt-2">${getCharacter(player).name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${pInfo.roll ? `<p class="font-bangers text-5xl mt-2">${pInfo.roll} ðŸŽ²</p>` : '<p class="text-gray-500">In attesa...</p>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â }).join('');

Â  Â  Â  Â  Â  Â  Â let message = "C'Ã¨ un pareggio! I seguenti concorrenti si sfideranno in uno spareggio con i dadi. Chi ottiene il punteggio piÃ¹ basso verrÃ  eliminato.";
Â  Â  Â  Â  Â  Â  Â if (tiebreaker.lastResult === 'tie') {
Â  Â  Â  Â  Â  Â  Â  Â  Â message = "Ancora un pareggio! Si lancia di nuovo tra i concorrenti con il punteggio piÃ¹ basso.";
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â let playerControls = '<p class="font-bold">Attendi il tuo turno per lanciare...</p>';
Â  Â  Â  Â  Â  Â  Â if (iAmInTiebreaker && myRollInfo && myRollInfo.roll === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â playerControls = '<button data-action="playerRollsDice" class="btn">Lancia il Dado!</button>';
Â  Â  Â  Â  Â  Â  Â } else if (iAmInTiebreaker && myRollInfo && myRollInfo.roll !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â playerControls = '<p class="font-bold">Hai lanciato! Attendi gli altri...</p>';
Â  Â  Â  Â  Â  Â  Â } else if (!iAmInTiebreaker) {
Â  Â  Â  Â  Â  Â  Â  Â  Â playerControls = '<p class="font-bold">Stai assistendo a uno spareggio!</p>';
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const hostControls = isHost ? `<button data-action="hostForcesDiceRoll" class="btn bg-orange-500 hover:bg-orange-600 mt-4">Forza Lancio Dadi</button>` : '';


Â  Â  Â  Â  Â  Â  Â const screenHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="panel text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h2 class="font-bangers text-5xl text-red-600 mb-4">SPAREGGIO!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-xl mb-6">${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-center gap-8 my-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${playersInTiebreakerHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${playerControls}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${hostControls}
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â appContainer.innerHTML = renderWithSidePanels(screenHtml);
Â  Â  Â  Â  Â  Â  Â updateChatView();
Â  Â  Â  Â  };

Â  Â  Â  Â  const renderFinale = () => {
Â  Â  Â  Â  Â  Â  const { settings, players, finale } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const myPlayer = players.find(p => p.uid === globalState.currentUser.uid);
Â  Â  Â  Â  Â  Â  const isHost = globalState.currentUser.uid === globalState.gameData.hostId;
Â  Â  Â  Â  Â  Â  const getCharacter = (uid) => {
Â  Â  Â  Â  Â  Â  Â  Â  const player = players.find(p => p.uid === uid);
Â  Â  Â  Â  Â  Â  Â  Â  return settings.characters[player.characterIndex];
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const finalist1 = finale.players[0];
Â  Â  Â  Â  Â  Â  const finalist2 = finale.players[1];
Â  Â  Â  Â  Â  Â  const char1 = getCharacter(finalist1.uid);
Â  Â  Â  Â  Â  Â  const char2 = getCharacter(finalist2.uid);

Â  Â  Â  Â  Â  Â  const currentRound = finale.rounds[finale.rounds.length - 1];
Â  Â  Â  Â  Â  Â  const myUid = myPlayer.uid;
Â  Â  Â  Â  Â  Â  const iAmInFinale = myUid === finalist1.uid || myUid === finalist2.uid;
Â  Â  Â  Â  Â  Â  const canIRoll = iAmInFinale && (
Â  Â  Â  Â  Â  Â  Â  Â  (myUid === finalist1.uid && currentRound.roll1 === null) ||
Â  Â  Â  Â  Â  Â  Â  Â  (myUid === finalist2.uid && currentRound.roll2 === null)
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  let playerControls = '';
Â  Â  Â  Â  Â  Â  if (canIRoll) {
Â  Â  Â  Â  Â  Â  Â  Â  playerControls = `<button data-action="playerRollsDiceFinale" class="btn">Lancia il Dado!</button>`;
Â  Â  Â  Â  Â  Â  } else if (iAmInFinale) {
Â  Â  Â  Â  Â  Â  Â  Â  playerControls = `<p class="font-bold">Hai lanciato! Attendi il tuo avversario...</p>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  playerControls = `<p class="font-bold">Stai assistendo alla finale!</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const hostControls = isHost ? `<button data-action="hostForcesFinaleRoll" class="btn bg-orange-500 hover:bg-orange-600 mt-4">Forza Lancio</button>` : '';

Â  Â  Â  Â  Â  Â  const roundsHistoryHtml = finale.rounds.map((round, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (round.winner === null && round.roll1 === null) return ''; // Non mostrare il round corrente se non Ã¨ iniziato
Â  Â  Â  Â  Â  Â  Â  Â  let resultText = `Round ${index + 1}: In corso...`;
Â  Â  Â  Â  Â  Â  Â  Â  if (round.winner && round.winner !== 'tie') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const winnerName = getCharacter(round.winner).name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultText = `Round ${index + 1}: <span class="font-bold text-green-600">${winnerName}</span> vince (${round.roll1} a ${round.roll2})`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (round.roll1 !== null && round.roll2 !== null && round.winner === 'tie') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultText = `Round ${index + 1}: Pareggio! (${round.roll1} a ${round.roll2}) Si rilancia!`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return `<li class="bg-amber-200 p-2 rounded">${resultText}</li>`;
Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  const screenHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-6xl text-yellow-400" style="text-shadow: 2px 2px 0 #000;">GRAN FINALE!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl mb-6">Il primo che vince 3 round Ã¨ il campione di A Tutto Reality!</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-around items-start my-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Finalista 1 -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${char1.img}" class="w-32 h-32 object-cover rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-2xl mt-2">${char1.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bangers text-5xl">${finalist1.score}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${currentRound.roll1 ? `<p class="font-bangers text-4xl text-blue-600">ðŸŽ² ${currentRound.roll1}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bangers text-7xl pt-16">VS</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Finalista 2 -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${char2.img}" class="w-32 h-32 object-cover rounded-full border-4 border-black">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-2xl mt-2">${char2.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bangers text-5xl">${finalist2.score}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${currentRound.roll2 ? `<p class="font-bangers text-4xl text-red-600">ðŸŽ² ${currentRound.roll2}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${playerControls}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${hostControls}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8 max-w-md mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-3xl mb-2">Storico Round</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="space-y-2">${roundsHistoryHtml}</ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = renderWithSidePanels(screenHtml);
Â  Â  Â  Â  Â  Â  updateChatView();
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const renderGameOver = () => {
Â  Â  Â  Â  Â  Â  const { settings, players, winnerUid } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const winnerPlayer = players.find(p => p.uid === winnerUid);
Â  Â  Â  Â  Â  Â  const winnerCharacter = settings.characters[winnerPlayer.characterIndex];

Â  Â  Â  Â  Â  Â  const screenHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="panel text-center fade-in">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-bangers text-5xl text-amber-500">ABBIAMO UN VINCITORE!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${winnerCharacter.img}" class="w-48 h-48 object-cover rounded-full border-8 border-yellow-400 mx-auto my-6 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-bangers text-6xl">${winnerCharacter.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-2xl font-bold">Ã¨ il campione di A Tutto Reality: La Sfida Online!</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${renderEliminationRanking()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="goToMainMenu" class="btn bg-blue-500 hover:bg-blue-600 mt-8">Torna al Menu Principale</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = renderWithSidePanels(screenHtml);
Â  Â  Â  Â  Â  Â  updateChatView();
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- LOGICA DI GIOCO E GESTIONE EVENTI ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  const preGameAction = (action, id = null) => {
Â  Â  Â  Â  Â  Â  const nicknameInput = document.getElementById('nickname-input');
Â  Â  Â  Â  Â  Â  const nickname = nicknameInput ? nicknameInput.value.trim() : globalState.nickname;

Â  Â  Â  Â  Â  Â  if (!nickname) {
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Per favore, inserisci un nickname per continuare.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  globalState.nickname = nickname;

Â  Â  Â  Â  Â  Â  switch (action) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'goToCreateGame': globalState.currentScreen = 'createGame'; render(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'goToJoinGame': globalState.currentScreen = 'joinGame'; render(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'goToFindGame': globalState.currentScreen = 'findGame'; render(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'joinWithId': joinGame(id); break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const handleAppClick = (e) => {
Â  Â  Â  Â  Â  Â  const target = e.target.closest('[data-action]');
Â  Â  Â  Â  Â  Â  if (!target) return;

Â  Â  Â  Â  Â  Â  const { action, id, index, uid } = target.dataset;

Â  Â  Â  Â  Â  Â  // Gestione azioni pre-partita
Â  Â  Â  Â  Â  Â  const preGameActions = ['goToCreateGame', 'goToJoinGame', 'goToFindGame', 'joinWithId'];
Â  Â  Â  Â  Â  Â  if (preGameActions.includes(action)) {
Â  Â  Â  Â  Â  Â  Â  Â  preGameAction(action, id);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Gestione azioni in-partita
Â  Â  Â  Â  Â  Â  switch (action) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'goToMainMenu': leaveGameCleanup(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'addCharacter': addCharacterRow(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'removeCharacter': target.closest('.character-row').remove(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'startGame': startGame(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'testFinale': testFinale(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'leaveGame': leaveGame(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'selectCharacter': if (!target.classList.contains('selected-by-other')) selectCharacter(index); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'runChallenge': runChallenge(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'goToElimination': goToElimination(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'votePlayer': submitVote(uid); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'startVoteReveal': startVoteReveal(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'revealNextSafe': revealNextSafe(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'nextEpisode': nextEpisode(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'playerRollsDice': playerRollsDice(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'hostForcesDiceRoll': hostForcesDiceRoll(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'playerRollsDiceFinale': playerRollsDiceFinale(); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'hostForcesFinaleRoll': hostForcesFinaleRoll(); break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const handleAppSubmit = (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const formId = e.target.id;
Â  Â  Â  Â  Â  Â  if (formId === 'create-game-form') createGame();
Â  Â  Â  Â  Â  Â  else if (formId === 'join-game-form') {
Â  Â  Â  Â  Â  Â  Â  Â  const code = document.getElementById('game-code').value.toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  if (code) joinGame(code);
Â  Â  Â  Â  Â  Â  } else if (formId === 'chat-form') {
Â  Â  Â  Â  Â  Â  Â  Â  handleSendMessage();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const updateTeamConfigs = () => {
Â  Â  Â  Â  Â  Â  const teamCount = parseInt(document.getElementById('team-count').value) || 2;
Â  Â  Â  Â  Â  Â  const container = document.getElementById('team-configs');
Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= teamCount; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `<label class="font-bold">Nome Team ${i}:</label><input type="text" class="team-name w-full p-2 border-2 border-black rounded" value="Team ${i}">`;
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const updateReturnEpisodes = () => {
Â  Â  Â  Â  Â  Â  const returnCount = parseInt(document.getElementById('return-count').value) || 0;
Â  Â  Â  Â  Â  Â  const container = document.getElementById('return-episodes');
Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= returnCount; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `<label class="font-bold">Episodio Ritorno ${i}:</label><input type="number" class="return-episode w-full p-2 border-2 border-black rounded" value="${3 + i*2}">`;
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const addCharacterRow = (index = null, pool = FULL_CHARACTER_POOL) => {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('characters-list');
Â  Â  Â  Â  Â  Â  const charIndex = index !== null ? index : list.children.length;
Â  Â  Â  Â  Â  Â  const defaultChar = pool[charIndex] || { name: `Personaggio ${charIndex + 1}`, img: '' };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = 'character-row grid grid-cols-1 md:grid-cols-6 gap-2 items-center';
Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Nome Personaggio" class="character-name w-full p-2 border-2 border-black rounded md:col-span-2" value="${defaultChar.name}">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="URL Immagine (obbligatorio)" class="character-img-url w-full p-2 border-2 border-black rounded md:col-span-3" value="${defaultChar.img}">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-action="removeCharacter" class="btn bg-red-500 hover:bg-red-600 text-sm py-1 px-2 justify-self-start md:justify-self-center">X</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  };

Â  Â  Â  Â  const createGame = async () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const characterRows = document.querySelectorAll('.character-row');
Â  Â  Â  Â  Â  Â  Â  Â  const characters = Array.from(characterRows).map((row, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nameInput = row.querySelector('.character-name');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const urlInput = row.querySelector('.character-img-url');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = nameInput.value.trim() || `Personaggio ${index + 1}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = urlInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!img) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`L'immagine per il personaggio "${name}" Ã¨ obbligatoria.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { name, img };
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const settings = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerCount: parseInt(document.getElementById('player-count').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamCount: parseInt(document.getElementById('team-count').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teams: Array.from(document.querySelectorAll('.team-name')).map((input, i) => ({ id: i + 1, name: input.value.trim() || `Team ${i + 1}`, color: `team-color-${i + 1}` })),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mergeEpisode: parseInt(document.getElementById('merge-episode').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returnCount: parseInt(document.getElementById('return-count').value),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returnEpisodes: Array.from(document.querySelectorAll('.return-episode')).map(input => parseInt(input.value)),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  characters: characters,
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const newGameId = generateId();
Â  Â  Â  Â  Â  Â  Â  Â  const hostPlayer = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: globalState.currentUser.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: globalState.nickname,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isHost: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  characterIndex: null,
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const gameData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: newGameId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hostId: globalState.currentUser.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'waiting',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: [hostPlayer],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  episode: 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminationOrder: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isMerged: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createdAt: new Date(),
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, newGameId);
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(gameRef, gameData);
Â  Â  Â  Â  Â  Â  Â  Â  joinGame(newGameId);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore dettagliato nella creazione della partita:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showModal(error.message || "Impossibile creare la partita. Controlla che tutti i campi siano corretti.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const joinGame = async (gameId) => {
Â  Â  Â  Â  Â  Â  if (!gameId) { showModal("Codice non valido."); return; }
Â  Â  Â  Â  Â  Â  if (!globalState.nickname) { showModal("Per favore, torna al menu e inserisci un nickname."); return; }

Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  Â  Â  if (!gameDoc.exists()) { showModal(`Partita con codice ${gameId} non trovata.`); return; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let gameData = gameDoc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const myUid = globalState.currentUser.uid;

Â  Â  Â  Â  Â  Â  Â  Â  if (!gameData.players.some(p => p.uid === myUid)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (gameData.players.length >= gameData.settings.playerCount) { showModal("Questa partita Ã¨ piena!"); return; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (gameData.status !== 'waiting') { showModal("Questa partita Ã¨ giÃ  iniziata!"); return; }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newPlayer = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: myUid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: globalState.nickname,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isHost: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  characterIndex: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { players: [...gameData.players, newPlayer] });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  globalState.gameId = gameId;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (globalState.unsubscribeGame) globalState.unsubscribeGame();
Â  Â  Â  Â  Â  Â  Â  Â  globalState.unsubscribeGame = onSnapshot(gameRef, (doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (doc.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oldStatus = globalState.gameData ? globalState.gameData.status : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globalState.gameData = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newStatus = globalState.gameData.status;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (oldStatus !== 'tiebreaker' && newStatus === 'tiebreaker' && globalState.gameData.hostId === globalState.currentUser.uid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rollCpuDiceInTiebreaker();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (oldStatus !== 'finale' && newStatus === 'finale' && globalState.gameData.hostId === globalState.currentUser.uid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(checkFinaleCompletion, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newScreen = getScreenFromStatus(newStatus);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(globalState.currentScreen !== newScreen){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globalState.currentScreen = newScreen;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const screenContainer = document.getElementById('screen-container');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(screenContainer) render();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal("La partita non esiste piÃ¹.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leaveGameCleanup();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (globalState.unsubscribeChat) globalState.unsubscribeChat();
Â  Â  Â  Â  Â  Â  Â  Â  const chatRef = collection(db, `artifacts/${appId}/public/data/games`, gameId, 'chat');
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(chatRef, orderBy("timestamp"));
Â  Â  Â  Â  Â  Â  Â  Â  globalState.unsubscribeChat = onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globalState.chatMessages = snapshot.docs.map(doc => doc.data());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateChatView();
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Impossibile unirsi alla partita. Riprova.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const leaveGame = async () => {
Â  Â  Â  Â  Â  Â  if (!globalState.gameId || !globalState.currentUser) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  Â  Â  if (!gameDoc.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leaveGameCleanup();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const gameData = gameDoc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const updatedPlayers = gameData.players.filter(p => p.uid !== globalState.currentUser.uid);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (updatedPlayers.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se l'ultimo giocatore esce, cancella la partita
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(gameRef);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se l'host esce, nomina un nuovo host
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (gameData.hostId === globalState.currentUser.uid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newHost = updatedPlayers.find(p => !p.isCpu) || updatedPlayers[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newHost) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { players: updatedPlayers, hostId: newHost.uid });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await updateDoc(gameRef, { players: updatedPlayers });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Errore nell'uscire dalla partita:", error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â leaveGameCleanup();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const leaveGameCleanup = () => {
Â  Â  Â  Â  Â  Â  if(globalState.unsubscribeGame) globalState.unsubscribeGame();
Â  Â  Â  Â  Â  Â  if(globalState.unsubscribeChat) globalState.unsubscribeChat();
Â  Â  Â  Â  Â  Â  globalState.gameId = null;
Â  Â  Â  Â  Â  Â  globalState.gameData = null;
Â  Â  Â  Â  Â  Â  globalState.chatMessages = [];
Â  Â  Â  Â  Â  Â  globalState.unsubscribeGame = null;
Â  Â  Â  Â  Â  Â  globalState.unsubscribeChat = null;
Â  Â  Â  Â  Â  Â  globalState.currentScreen = 'mainMenu';
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const getScreenFromStatus = (status) => {
Â  Â  Â  Â  Â  Â  switch(status){
Â  Â  Â  Â  Â  Â  Â  Â  case 'waiting': return 'lobby';
Â  Â  Â  Â  Â  Â  Â  Â  case 'character-selection': return 'characterSelection';
Â  Â  Â  Â  Â  Â  Â  Â  case 'challenge': case 'challenge_result': case 'elimination': case 'reveal': case 'reveal_in_progress': case 'revealed': case 'tiebreaker': case 'finale': case 'game_over': return 'game';
Â  Â  Â  Â  Â  Â  Â  Â  default: return 'mainMenu';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const handleSendMessage = async () => {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('chat-input');
Â  Â  Â  Â  Â  Â  const text = input.value.trim();
Â  Â  Â  Â  Â  Â  if (text === '' || !globalState.gameId) return;

Â  Â  Â  Â  Â  Â  const myPlayer = globalState.gameData.players.find(p => p.uid === globalState.currentUser.uid);
Â  Â  Â  Â  Â  Â  if (!myPlayer) return;

Â  Â  Â  Â  Â  Â  const chatRef = collection(db, `artifacts/${appId}/public/data/games`, globalState.gameId, 'chat');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(chatRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  senderId: myPlayer.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  senderName: myPlayer.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: text,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Impossibile inviare il messaggio.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const startGame = async () => {
Â  Â  Â  Â  Â  Â  if (!globalState.gameId) return;
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const { players, settings } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const playersNeeded = settings.playerCount - players.length;
Â  Â  Â  Â  Â  Â  const newCpuPlayers = [];
Â  Â  Â  Â  Â  Â  for(let i=0; i < playersNeeded; i++){
Â  Â  Â  Â  Â  Â  Â  Â  newCpuPlayers.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: `CPU-${generateId(8)}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: `CPU ${i+1}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isCpu: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  characterIndex: null,
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const allPlayers = [...players, ...newCpuPlayers];

Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { status: 'character-selection', players: allPlayers });
Â  Â  Â  Â  };

Â  Â  Â  Â  const testFinale = async () => {
Â  Â  Â  Â  Â  Â  if (!globalState.gameId) return;
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const { players, settings } = globalState.gameData;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Aggiungi CPU se non ci sono abbastanza giocatori
Â  Â  Â  Â  Â  Â  const playersNeeded = settings.playerCount - players.length;
Â  Â  Â  Â  Â  Â  const allPlayers = [...players];
Â  Â  Â  Â  Â  Â  Â for(let i=0; i < playersNeeded; i++){
Â  Â  Â  Â  Â  Â  Â  Â  allPlayers.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: `CPU-${generateId(8)}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: `CPU ${i+1}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isCpu: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  characterIndex: null,
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Assegna personaggi a tutti
Â  Â  Â  Â  Â  Â  let availableIndexes = settings.characters.map((_, i) => i);
Â  Â  Â  Â  Â  Â  allPlayers.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  if (p.characterIndex === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const randomIndex = Math.floor(Math.random() * availableIndexes.length);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.characterIndex = availableIndexes.splice(randomIndex, 1)[0];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const finalists = allPlayers.slice(0, 2);
Â  Â  Â  Â  Â  Â  if (finalists.length < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Servono almeno 2 giocatori per testare la finale.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const updatedPlayers = allPlayers.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  if (finalists.some(f => f.uid === p.uid)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...p, status: 'active' };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return { ...p, status: 'eliminated' };
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  status: 'finale',
Â  Â  Â  Â  Â  Â  Â  Â  players: updatedPlayers,
Â  Â  Â  Â  Â  Â  Â  Â  isMerged: true, // La finale Ã¨ sempre post-merge
Â  Â  Â  Â  Â  Â  Â  Â  finale: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: finalists.map(p => ({ uid: p.uid, score: 0 })),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rounds: [{ roll1: null, roll2: null, winner: null }]
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  const selectCharacter = async (charIndexStr) => {
Â  Â  Â  Â  Â  Â  const charIndex = parseInt(charIndexStr);
Â  Â  Â  Â  Â  Â  if(isNaN(charIndex)) return;

Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  const myUid = globalState.currentUser.uid;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  if (!gameDoc.exists()) return;
Â  Â  Â  Â  Â  Â  const gameData = gameDoc.data();

Â  Â  Â  Â  Â  Â  if(gameData.players.some(p => p.characterIndex === charIndex)) {
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Questo personaggio Ã¨ giÃ  stato scelto!");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const updatedPlayers = gameData.players.map(p => p.uid === myUid ? { ...p, characterIndex: charIndex } : p);
Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { players: updatedPlayers });
Â  Â  Â  Â  Â  Â  checkAllCharactersSelected();
Â  Â  Â  Â  };

Â  Â  Â  Â  const checkAllCharactersSelected = async () => {
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  Â if (!gameDoc.exists()) return;
Â  Â  Â  Â  Â  Â  const gameData = gameDoc.data();

Â  Â  Â  Â  Â  Â  const humanPlayers = gameData.players.filter(p => !p.isCpu);
Â  Â  Â  Â  Â  Â  if (humanPlayers.every(p => p.characterIndex !== null)) {
Â  Â  Â  Â  Â  Â  Â  Â  let availableIndexes = gameData.settings.characters.map((_, i) => i).filter(i => !gameData.players.some(p => p.characterIndex === i));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const finalPlayers = gameData.players.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (p.isCpu && p.characterIndex === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const randomIndex = Math.floor(Math.random() * availableIndexes.length);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.characterIndex = availableIndexes.splice(randomIndex, 1)[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return p;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  assignTeams(finalPlayers, gameData.settings.teams);
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { status: 'challenge', players: finalPlayers, teams: gameData.settings.teams });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const assignTeams = (players, teams) => {
Â  Â  Â  Â  Â  Â  const shuffledPlayers = [...players].sort(() => 0.5 - Math.random());
Â  Â  Â  Â  Â  Â  const teamSlots = [];
Â  Â  Â  Â  Â  Â  const playerCount = players.length;
Â  Â  Â  Â  Â  Â  const teamCount = teams.length;

Â  Â  Â  Â  Â  Â  for (let i = 0; i < playerCount; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  teamSlots.push(teams[i % teamCount].id);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (let i = teamSlots.length - 1; i > 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  Â  Â  Â  Â  [teamSlots[i], teamSlots[j]] = [teamSlots[j], teamSlots[i]];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  shuffledPlayers.forEach((player, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  player.teamId = teamSlots[index];
Â  Â  Â  Â  Â  Â  Â  Â  player.status = 'active';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  const runChallenge = async () => {
Â  Â  Â  Â  Â  Â  const { teams, isMerged } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);

Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { status: 'elimination', votes: {} });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const teamIds = teams.map(t => t.id);
Â  Â  Â  Â  Â  Â  Â  Â  const losingTeamIndex = Math.floor(Math.random() * teamIds.length);
Â  Â  Â  Â  Â  Â  Â  Â  const losingTeamId = teamIds[losingTeamIndex];
Â  Â  Â  Â  Â  Â  Â  Â  const winningTeamIds = teamIds.filter(id => id !== losingTeamId);
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { status: 'challenge_result', challengeResult: { winningTeamIds, losingTeamId } });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const goToElimination = async () => {
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  if (!gameDoc.exists()) return;
Â  Â  Â  Â  Â  Â  const gameData = gameDoc.data();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const { players, challengeResult } = gameData;
Â  Â  Â  Â  Â  Â  const atRiskPlayers = players.filter(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  p.status === 'active' &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  p.teamId === challengeResult.losingTeamId
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  if (atRiskPlayers.length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  // Eliminazione automatica
Â  Â  Â  Â  Â  Â  Â  Â  const eliminatedUid = atRiskPlayers[0].uid;
Â  Â  Â  Â  Â  Â  Â  Â  const updatedPlayers = players.map(p => p.uid === eliminatedUid ? { ...p, status: 'eliminated' } : p);
Â  Â  Â  Â  Â  Â  Â  Â  const eliminationOrder = [...(gameData.eliminationOrder || []), eliminatedUid];
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'revealed',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: updatedPlayers,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elimination: { eliminatedUid, voteCounts: { [eliminatedUid]: 'Auto-eliminato' } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminationOrder
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { status: 'elimination', votes: {} });

Â  Â  Â  Â  Â  Â  const updatedGameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  const updatedGameData = updatedGameDoc.data();
Â  Â  Â  Â  Â  Â  const updatedAtRisk = updatedGameData.players.filter(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  p.status === 'active' &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  p.teamId === updatedGameData.challengeResult.losingTeamId
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  const hasHumanVoters = updatedAtRisk.some(p => !p.isCpu);

Â  Â  Â  Â  Â  Â  if (!hasHumanVoters && updatedAtRisk.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const newVotes = {};
Â  Â  Â  Â  Â  Â  Â  Â  updatedAtRisk.forEach(voter => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const potentialTargets = updatedAtRisk.filter(p => p.uid !== voter.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (potentialTargets.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const target = potentialTargets[Math.floor(Math.random() * potentialTargets.length)];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newVotes[voter.uid] = target.uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { votes: newVotes, status: 'reveal' });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const submitVote = async (votedPlayerUid) => {
Â  Â  Â  Â  Â  Â  const { players, challengeResult, isMerged } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const myPlayer = players.find(p => p.uid === globalState.currentUser.uid);

Â  Â  Â  Â  Â  Â  if (myPlayer.status === 'eliminated') {
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Non puoi votare, sei stato eliminato!");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!isMerged && myPlayer.teamId !== challengeResult.losingTeamId) {
Â  Â  Â  Â  Â  Â  Â  Â  showModal("Non puoi votare, il tuo team Ã¨ salvo!");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const myUid = globalState.currentUser.uid;
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { [`votes.${myUid}`]: votedPlayerUid });
Â  Â  Â  Â  Â  Â  checkAllVotesIn();
Â  Â  Â  Â  };

Â  Â  Â  Â  const checkAllVotesIn = async () => {
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  if (!gameDoc.exists()) return;
Â  Â  Â  Â  Â  Â  const gameData = gameDoc.data();

Â  Â  Â  Â  Â  Â  const { players, challengeResult, votes, isMerged, immunePlayerUid } = gameData;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let voters;
Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  voters = players.filter(p => p.status === 'active');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  voters = players.filter(p => p.status === 'active' && p.teamId === challengeResult.losingTeamId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  let cpuVoted = false;
Â  Â  Â  Â  Â  Â  voters.forEach(voter => {
Â  Â  Â  Â  Â  Â  Â  Â  if (voter.isCpu && !votes[voter.uid]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let potentialTargets;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  potentialTargets = players.filter(p => p.status === 'active' && p.uid !== voter.uid && p.uid !== immunePlayerUid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  potentialTargets = players.filter(p => p.status === 'active' && p.teamId === voter.teamId && p.uid !== voter.uid);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (potentialTargets.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const target = potentialTargets[Math.floor(Math.random() * potentialTargets.length)];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(gameRef, { [`votes.${voter.uid}`]: target.uid });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cpuVoted = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (cpuVoted) await batch.commit();

Â  Â  Â  Â  Â  Â  const finalDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  const finalData = finalDoc.data();
Â  Â  Â  Â  Â  Â  let finalVoters;
Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  finalVoters = finalData.players.filter(p => p.status === 'active');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  finalVoters = finalData.players.filter(p => p.status === 'active' && finalData.challengeResult.losingTeamId === p.teamId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (finalVoters.length === Object.keys(finalData.votes).length) {
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { status: 'reveal' });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const startVoteReveal = async () => {
Â  Â  Â  Â  Â  Â  const { players, votes, challengeResult, isMerged } = globalState.gameData;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let atRiskPlayers;
Â  Â  Â  Â  Â  Â  if (isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  atRiskPlayers = players.filter(p => p.status === 'active');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  atRiskPlayers = players.filter(p => p.status === 'active' && p.teamId === challengeResult.losingTeamId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const voteCounts = {};
Â  Â  Â  Â  Â  Â  atRiskPlayers.forEach(p => voteCounts[p.uid] = 0);Â 

Â  Â  Â  Â  Â  Â  for(const voterUid in votes) {
Â  Â  Â  Â  Â  Â  Â  Â  const votedUid = votes[voterUid];
Â  Â  Â  Â  Â  Â  Â  Â  if(voteCounts.hasOwnProperty(votedUid)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  voteCounts[votedUid]++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const maxVotes = Math.max(...Object.values(voteCounts));
Â  Â  Â  Â  Â  Â  const tiedPlayersUids = Object.keys(voteCounts).filter(uid => voteCounts[uid] === maxVotes);

Â  Â  Â  Â  Â  Â  if (tiedPlayersUids.length > 1 && maxVotes > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'tiebreaker',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiebreaker: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: tiedPlayersUids.map(uid => ({ uid, roll: null })),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastResult: null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const sortedAtRiskUids = atRiskPlayers.map(p => p.uid).sort((a, b) => voteCounts[a] - voteCounts[b]);

Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  status: 'reveal_in_progress',
Â  Â  Â  Â  Â  Â  Â  Â  elimination: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atRisk: sortedAtRiskUids,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  safePlayers: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  voteCounts: voteCounts,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminatedUid: null
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  revealNextSafe();
Â  Â  Â  Â  };

Â  Â  Â  Â  const revealNextSafe = async () => {
Â  Â  Â  Â  Â  Â  const { elimination, players } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const atRiskUids = elimination.atRisk;
Â  Â  Â  Â  Â  Â  const safePlayers = elimination.safePlayers;

Â  Â  Â  Â  Â  Â  if (atRiskUids.length - safePlayers.length <= 1) {
Â  Â  Â  Â  Â  Â  Â  Â  const eliminatedUid = atRiskUids.find(uid => !safePlayers.includes(uid));
Â  Â  Â  Â  Â  Â  Â  Â  const updatedPlayers = players.map(p => p.uid === eliminatedUid ? { ...p, status: 'eliminated' } : p);
Â  Â  Â  Â  Â  Â  Â  Â  const eliminationOrder = [...(globalState.gameData.eliminationOrder || []), eliminatedUid];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'revealed',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: updatedPlayers,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'elimination.eliminatedUid': eliminatedUid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminationOrder: eliminationOrder
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const nextSafeUid = atRiskUids[safePlayers.length];
Â  Â  Â  Â  Â  Â  Â  Â  const updatedSafePlayers = [...safePlayers, nextSafeUid];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'elimination.safePlayers': updatedSafePlayers
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const playerRollsDice = async () => {
Â  Â  Â  Â  Â  Â  const { tiebreaker } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const myUid = globalState.currentUser.uid;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const myTieInfo = tiebreaker.players.find(p => p.uid === myUid);
Â  Â  Â  Â  Â  Â  if (!myTieInfo || myTieInfo.roll !== null) return;

Â  Â  Â  Â  Â  Â  const newRoll = Math.floor(Math.random() * 6) + 1;
Â  Â  Â  Â  Â  Â  const updatedTiePlayers = tiebreaker.players.map(p => p.uid === myUid ? { ...p, roll: newRoll } : p);

Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { 'tiebreaker.players': updatedTiePlayers });

Â  Â  Â  Â  Â  Â  checkTiebreakerCompletion();
Â  Â  Â  Â  };

Â  Â  Â  Â  const rollCpuDiceInTiebreaker = async () => {
Â  Â  Â  Â  Â  Â  const { players, tiebreaker } = globalState.gameData;
Â  Â  Â  Â  Â  Â  if (!tiebreaker) return;

Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  let cpusRolled = false;

Â  Â  Â  Â  Â  Â  const updatedTiePlayers = tiebreaker.players.map(pInfo => {
Â  Â  Â  Â  Â  Â  Â  Â  const player = players.find(p => p.uid === pInfo.uid);
Â  Â  Â  Â  Â  Â  Â  Â  if (player.isCpu && pInfo.roll === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cpusRolled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...pInfo, roll: Math.floor(Math.random() * 6) + 1 };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return pInfo;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (cpusRolled) {
Â  Â  Â  Â  Â  Â  Â  Â  batch.update(gameRef, { 'tiebreaker.players': updatedTiePlayers });
Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  checkTiebreakerCompletion();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const checkTiebreakerCompletion = async () => {
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  if (!gameDoc.exists()) return;
Â  Â  Â  Â  Â  Â  const { players, tiebreaker } = gameDoc.data();

Â  Â  Â  Â  Â  Â  if (tiebreaker.players.every(p => p.roll !== null)) {
Â  Â  Â  Â  Â  Â  Â  Â  const minRoll = Math.min(...tiebreaker.players.map(p => p.roll));
Â  Â  Â  Â  Â  Â  Â  Â  const losers = tiebreaker.players.filter(p => p.roll === minRoll);

Â  Â  Â  Â  Â  Â  Â  Â  if (losers.length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const eliminatedUid = losers[0].uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatedPlayers = players.map(p => p.uid === eliminatedUid ? { ...p, status: 'eliminated' } : p);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const eliminationOrder = [...(globalState.gameData.eliminationOrder || []), eliminatedUid];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'revealed',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: updatedPlayers,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elimination: { eliminatedUid: eliminatedUid, voteCounts: { [eliminatedUid]: 'Spareggio' } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiebreaker: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminationOrder: eliminationOrder
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tiebreaker.players': losers.map(p => ({ uid: p.uid, roll: null })),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tiebreaker.lastResult': 'tie'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (globalState.gameData.hostId === globalState.currentUser.uid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(rollCpuDiceInTiebreaker, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const hostForcesDiceRoll = async () => {
Â  Â  Â  Â  Â  Â  const { tiebreaker } = globalState.gameData;
Â  Â  Â  Â  Â  Â  if (!tiebreaker) return;

Â  Â  Â  Â  Â  Â  const updatedTiePlayers = tiebreaker.players.map(pInfo => {
Â  Â  Â  Â  Â  Â  Â  Â  if (pInfo.roll === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...pInfo, roll: Math.floor(Math.random() * 6) + 1 };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return pInfo;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { 'tiebreaker.players': updatedTiePlayers });

Â  Â  Â  Â  Â  Â  checkTiebreakerCompletion();
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const nextEpisode = async () => {
Â  Â  Â  Â  Â  Â  const { settings, episode, players, eliminationOrder } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const newEpisodeNumber = episode + 1;
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  const activePlayers = players.filter(p => p.status === 'active');

Â  Â  Â  Â  Â  Â  if (activePlayers.length <= 2) {
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'finale',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finale: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: activePlayers.map(p => ({ uid: p.uid, score: 0 })),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rounds: [{ roll1: null, roll2: null, winner: null }]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (settings.returnEpisodes && settings.returnEpisodes.includes(newEpisodeNumber)) {
Â  Â  Â  Â  Â  Â  Â  Â  const eliminatedPlayers = players.filter(p => p.status === 'eliminated');
Â  Â  Â  Â  Â  Â  Â  Â  if (eliminatedPlayers.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const returningPlayer = eliminatedPlayers[Math.floor(Math.random() * eliminatedPlayers.length)];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatedPlayers = players.map(p => p.uid === returningPlayer.uid ? { ...p, status: 'active' } : p);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updatedEliminationOrder = eliminationOrder.filter(uid => uid !== returningPlayer.uid);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'return_result',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  players: updatedPlayers,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eliminationOrder: updatedEliminationOrder,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returningPlayerUid: returningPlayer.uid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => nextEpisode(), 5000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (newEpisodeNumber === settings.mergeEpisode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const immunePlayer = activePlayers[Math.floor(Math.random() * activePlayers.length)];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'challenge',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  episode: newEpisodeNumber,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isMerged: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  immunePlayerUid: immunePlayer.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  challengeResult: null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elimination: null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiebreaker: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  votes: {}Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (globalState.gameData.isMerged) {
Â  Â  Â  Â  Â  Â  Â  Â  const immunePlayer = activePlayers[Math.floor(Math.random() * activePlayers.length)];
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'challenge',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  episode: newEpisodeNumber,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  immunePlayerUid: immunePlayer.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  challengeResult: null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elimination: null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiebreaker: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  votes: {}Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {Â 
Â  Â  Â  Â  Â  Â  Â  Â  status: 'challenge',Â 
Â  Â  Â  Â  Â  Â  Â  Â  episode: newEpisodeNumber,Â 
Â  Â  Â  Â  Â  Â  Â  Â  challengeResult: null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  elimination: null,Â 
Â  Â  Â  Â  Â  Â  Â  Â  tiebreaker: null,
Â  Â  Â  Â  Â  Â  Â  Â  votes: {}Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  const playerRollsDiceFinale = async () => {
Â  Â  Â  Â  Â  Â  const { finale } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const myUid = globalState.currentUser.uid;
Â  Â  Â  Â  Â  Â  const currentRound = finale.rounds[finale.rounds.length - 1];

Â  Â  Â  Â  Â  Â  const myFinalistInfo = finale.players.find(p => p.uid === myUid);
Â  Â  Â  Â  Â  Â  if (!myFinalistInfo) return;

Â  Â  Â  Â  Â  Â  const isPlayer1 = finale.players[0].uid === myUid;
Â  Â  Â  Â  Â  Â  if ((isPlayer1 && currentRound.roll1 !== null) || (!isPlayer1 && currentRound.roll2 !== null)) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const newRoll = Math.floor(Math.random() * 6) + 1;
Â  Â  Â  Â  Â  Â  const updatedRounds = [...finale.rounds];
Â  Â  Â  Â  Â  Â  const newCurrentRound = updatedRounds[updatedRounds.length - 1];

Â  Â  Â  Â  Â  Â  if (isPlayer1) {
Â  Â  Â  Â  Â  Â  Â  Â  newCurrentRound.roll1 = newRoll;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  newCurrentRound.roll2 = newRoll;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { 'finale.rounds': updatedRounds });

Â  Â  Â  Â  Â  Â  checkFinaleCompletion();
Â  Â  Â  Â  };

Â  Â  Â  Â  const checkFinaleCompletion = async () => {
Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  const gameDoc = await getDoc(gameRef);
Â  Â  Â  Â  Â  Â  if (!gameDoc.exists()) return;
Â  Â  Â  Â  Â  Â  const gameData = gameDoc.data();
Â  Â  Â  Â  Â  Â  if (!gameData.finale) return;
Â  Â  Â  Â  Â  Â  const { players, finale } = gameData;

Â  Â  Â  Â  Â  Â  const currentRound = finale.rounds[finale.rounds.length - 1];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const finalist1 = players.find(p => p.uid === finale.players[0].uid);
Â  Â  Â  Â  Â  Â  const finalist2 = players.find(p => p.uid === finale.players[1].uid);

Â  Â  Â  Â  Â  Â  let cpuRolled = false;
Â  Â  Â  Â  Â  Â  const updatedRounds = [...finale.rounds];
Â  Â  Â  Â  Â  Â  const newCurrentRound = updatedRounds[updatedRounds.length - 1];

Â  Â  Â  Â  Â  Â  if (finalist1.isCpu && newCurrentRound.roll1 === null) {
Â  Â  Â  Â  Â  Â  Â  Â  newCurrentRound.roll1 = Math.floor(Math.random() * 6) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  cpuRolled = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (finalist2.isCpu && newCurrentRound.roll2 === null) {
Â  Â  Â  Â  Â  Â  Â  Â  newCurrentRound.roll2 = Math.floor(Math.random() * 6) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  cpuRolled = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (cpuRolled) {
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { 'finale.rounds': updatedRounds });
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(checkFinaleCompletion, 500);Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (newCurrentRound.roll1 !== null && newCurrentRound.roll2 !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  let updatedFinale = { ...finale };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (newCurrentRound.roll1 > newCurrentRound.roll2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newCurrentRound.winner = finale.players[0].uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedFinale.players[0].score++;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (newCurrentRound.roll2 > newCurrentRound.roll1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newCurrentRound.winner = finale.players[1].uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedFinale.players[1].score++;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newCurrentRound.winner = 'tie';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  updatedFinale.rounds[updatedFinale.rounds.length - 1] = newCurrentRound;

Â  Â  Â  Â  Â  Â  Â  Â  const winner = updatedFinale.players.find(p => p.score >= 3);
Â  Â  Â  Â  Â  Â  Â  Â  if (winner) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'game_over',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  winnerUid: winner.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finale: updatedFinale
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedFinale.rounds.push({ roll1: null, roll2: null, winner: null });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { finale: updatedFinale });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(checkFinaleCompletion, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  const hostForcesFinaleRoll = async () => {
Â  Â  Â  Â  Â  Â  const { finale } = globalState.gameData;
Â  Â  Â  Â  Â  Â  const updatedRounds = [...finale.rounds];
Â  Â  Â  Â  Â  Â  const currentRound = updatedRounds[updatedRounds.length - 1];

Â  Â  Â  Â  Â  Â  if (currentRound.roll1 === null) {
Â  Â  Â  Â  Â  Â  Â  Â  currentRound.roll1 = Math.floor(Math.random() * 6) + 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (currentRound.roll2 === null) {
Â  Â  Â  Â  Â  Â  Â  Â  currentRound.roll2 = Math.floor(Math.random() * 6) + 1;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const gameRef = doc(db, `artifacts/${appId}/public/data/games`, globalState.gameId);
Â  Â  Â  Â  Â  Â  await updateDoc(gameRef, { 'finale.rounds': updatedRounds });
Â  Â  Â  Â  Â  Â  checkFinaleCompletion();
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- INIZIALIZZAZIONE ---
Â  Â  Â  Â  const init = async () => {
Â  Â  Â  Â  Â  Â  if (!app) {
Â  Â  Â  Â  Â  Â  Â  Â  renderLoading();
Â  Â  Â  Â  Â  Â  Â  Â  appContainer.innerHTML = `<div class="panel text-center"><h2 class="font-bangers text-4xl text-red-600">Errore di Configurazione</h2><p class="mt-4">Impossibile inizializzare Firebase. Assicurati di aver inserito le tue credenziali nel campo <strong>firebaseConfig</strong> all'interno del codice HTML.</p></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globalState.currentUser = user;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Authentication failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal("Autenticazione fallita. L'app potrebbe non funzionare correttamente.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (globalState.currentScreen === 'loading') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globalState.currentScreen = 'mainMenu';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  appContainer.addEventListener('click', handleAppClick);
Â  Â  Â  Â  appContainer.addEventListener('submit', handleAppSubmit);
Â  Â  Â  Â  init();
Â  Â  </script>
</body>
</html>Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 